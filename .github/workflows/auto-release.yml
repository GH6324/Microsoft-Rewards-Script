name: Release and Docker Push

on:
    push:
        branches: [v3]
        paths:
            - package.json
    workflow_dispatch:

permissions:
    contents: write
    packages: write

env:
    REGISTRY: ghcr.io

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Normalize image name (lowercase)
              id: image
              run: |
                  set -euo pipefail
                  IMG="$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')"
                  echo "name=$IMG" >> "$GITHUB_OUTPUT"
                  echo "LOG: Image: ${{ env.REGISTRY }}/$IMG"

            - name: Read current version
              id: version
              run: |
                  set -euo pipefail
                  CUR_VERSION="$(node -p "require('./package.json').version")"
                  echo "current=$CUR_VERSION" >> "$GITHUB_OUTPUT"
                  echo "LOG: Current version: $CUR_VERSION"

            - name: Check if GitHub Release already exists
              id: relcheck
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  TAG="v${{ steps.version.outputs.current }}"
                  echo "LOG: Checking GitHub Release for tag: $TAG"

                  set +e
                  gh api "repos/${{ github.repository }}/releases/tags/$TAG" >/dev/null 2>&1
                  CODE=$?
                  set -e

                  if [ "$CODE" -eq 0 ]; then
                    echo "LOG: Release exists for $TAG"
                    echo "exists=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "LOG: Release does not exist for $TAG"
                    echo "exists=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Create GitHub Release
              if: steps.relcheck.outputs.exists != 'true'
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ steps.version.outputs.current }}
                  name: v${{ steps.version.outputs.current }}
                  generate_release_notes: true

            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Check if Docker image tag already exists
              id: imgcheck
              run: |
                  set -euo pipefail
                  IMAGE="${{ env.REGISTRY }}/${{ steps.image.outputs.name }}"
                  TAG="${{ steps.version.outputs.current }}"
                  REF="$IMAGE:$TAG"

                  echo "LOG: Checking image manifest: $REF"

                  set +e
                  docker manifest inspect "$REF" >/dev/null 2>&1
                  CODE=$?
                  set -e

                  if [ "$CODE" -eq 0 ]; then
                    echo "LOG: Image tag exists: $REF"
                    echo "exists=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "LOG: Image tag does not exist: $REF"
                    echo "exists=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Stop if Docker image already exists
              if: steps.imgcheck.outputs.exists == 'true'
              run: |
                  echo "LOG: Docker image already exists for version ${{ steps.version.outputs.current }}. Nothing to do."

            - name: Set up Docker Buildx
              if: steps.imgcheck.outputs.exists != 'true'
              uses: docker/setup-buildx-action@v3

            - name: Build and push Docker image
              if: steps.imgcheck.outputs.exists != 'true'
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: |
                      ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:${{ steps.version.outputs.current }}
                      ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
